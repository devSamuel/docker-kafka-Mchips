  services:
    kafka-controller:
      image: bitnamilegacy/kafka:latest
      hostname: kafka-controller-{{.Task.Slot}}
      deploy:
        resources:
          limits:
            cpus: '3.5'            
            memory: 6G        
          reservations:
            cpus: '0.5'           
            memory: 1024M         
        mode: replicated   
        replicas: 3
        placement:
          constraints:
            # Ensure controllers deploy to specific nodes if needed, e.g., 'node.labels.kafka-role == controller'
            # For a general swarm, simply ensuring unique hosts can be sufficient:
            - "node.id != an_invalid_id" # A placeholder constraint
      environment:
        # KRaft Settings
        - BITNAMI_DEBUG=true
        - KAFKA_CFG_NODE_ID={{.Task.Slot}}
        - KAFKA_CFG_PROCESS_ROLES=controller
        - KAFKA_KRAFT_CLUSTER_ID=HacAgFbaRJ6PuDyphbLNFA
        - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka-controller-1:9093,2@kafka-controller-2:9093,3@kafka-controller-3:9093
        # Listener Configuration
        # - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka-controller-{{.Task.Slot}}:9092
        - KAFKA_CFG_LISTENERS=CONTROLLER://:9093
        - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER    
        # Keep the map as is to satisfy the script requirements
        - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT
        # Data persistence (customize host path)
        - KAFKA_CFG_LOG_DIRS=/bitnami/kafka/data
        - KAFKA_HEAP_OPTS=${BROKER_HEAP_OPTS}
      networks:
        - kafka-net
    broker4:
      image: bitnamilegacy/kafka:latest
      hostname: broker4
      ports:
        - "9090:9092"
      environment:
        - KAFKA_CFG_NODE_ID=7 
        - KAFKA_CFG_PROCESS_ROLES=broker
        - KAFKA_KRAFT_CLUSTER_ID=HacAgFbaRJ6PuDyphbLNFA
        - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka-controller-1:9093,2@kafka-controller-2:9093,3@kafka-controller-3:9093
        - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092
        - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://broker4:9092 # Hardcoded Hostname
        - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
        - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
        - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
        - KAFKA_CFG_LOG_DIRS=/bitnami/kafka/data
        - KAFKA_HEAP_OPTS=${BROKER_HEAP_OPTS}
      volumes:
        - broker4-data:/bitnami/kafka/data
      networks:
        - kafka-net
      deploy:
        resources:
          limits:
            cpus: '3.5'
            memory: 6G
          reservations:
            cpus: '0.5'            # Reserve 0.5 CPU cores (guaranteed)
            memory: 1024M          # Reserve 1GB of RAM (guaranteed)
    broker3:
      image: bitnamilegacy/kafka:latest
      hostname: broker3
      ports:
        - "9091:9092"
      environment:
        - KAFKA_CFG_NODE_ID=4 # Hardcoded ID
        - KAFKA_CFG_PROCESS_ROLES=broker
        - KAFKA_KRAFT_CLUSTER_ID=HacAgFbaRJ6PuDyphbLNFA
        - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka-controller-1:9093,2@kafka-controller-2:9093,3@kafka-controller-3:9093
        - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092
        - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://broker3:9092 # Hardcoded Hostname
        - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
        - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
        - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
        - KAFKA_CFG_LOG_DIRS=/bitnami/kafka/data
        - KAFKA_HEAP_OPTS=${BROKER_HEAP_OPTS}
      volumes:
        - broker3-data:/bitnami/kafka/data
      networks:
        - kafka-net
      deploy:
        resources:
          limits:
            cpus: '4.5'
            memory: 6G
          reservations:
            cpus: '0.5'
            memory: 1024M
    broker2:
      image: bitnamilegacy/kafka:latest
      hostname: broker2
      ports:
        - "9092:9092"
      environment:
        - KAFKA_CFG_NODE_ID=5 
        - KAFKA_CFG_PROCESS_ROLES=broker
        - KAFKA_KRAFT_CLUSTER_ID=HacAgFbaRJ6PuDyphbLNFA
        - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka-controller-1:9093,2@kafka-controller-2:9093,3@kafka-controller-3:9093
        - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092
        - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://broker2:9092
        - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
        - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
        - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
        - KAFKA_CFG_LOG_DIRS=/bitnami/kafka/data
        - KAFKA_HEAP_OPTS=${BROKER_HEAP_OPTS}
      volumes:
        - broker2-data:/bitnami/kafka/data
      networks:
        - kafka-net
      deploy:
        resources:
          limits:
            cpus: '3.5'
            memory: 6G
          reservations:
            cpus: '0.5'
            memory: 1024M
    broker1:
      image: bitnamilegacy/kafka:latest
      hostname: broker1
      ports:
        - "9093:9092"
      environment:
        - KAFKA_CFG_NODE_ID=6 # Hardcoded ID
        - KAFKA_CFG_PROCESS_ROLES=broker
        - KAFKA_KRAFT_CLUSTER_ID=HacAgFbaRJ6PuDyphbLNFA
        - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka-controller-1:9093,2@kafka-controller-2:9093,3@kafka-controller-3:9093
        - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092
        - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://broker1:9092
        - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
        - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
        - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
        - KAFKA_CFG_LOG_DIRS=/bitnami/kafka/data
        - KAFKA_HEAP_OPTS=${BROKER_HEAP_OPTS}
      volumes:
        - broker1-data:/bitnami/kafka/data
      networks:
        - kafka-net
      deploy:
        resources:
          limits:
            cpus: '3.5'
            memory: 6G
          reservations:
            cpus: '0.5'
            memory: 1024M
    # ============================================================================
    # MONITORING UI (Proven tool for management)
    # ============================================================================
    kafka-ui:
      image: provectuslabs/kafka-ui:latest
      ports:
        - "8081:8080"
      environment:
        KAFKA_S_0_NAME: ProdKRaft23
        DYNAMIC_CONFIG_ENABLED: 'true'
        KAFKA_CLUSTERS_0_NAME: local-cluster
        KAFKA_S_0_BOOTSTRAPSERVERS: 'broker1:9092,broker2:9092,broker3:9092,broker4:9092'
      networks:
        - kafka-net
  networks:
    kafka-net:
  volumes:
    broker1-data:
    broker2-data:
    broker3-data:
    broker4-data: